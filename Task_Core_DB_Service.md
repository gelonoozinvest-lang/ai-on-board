# Техническое задание (ТЗ) для Сервиса Базы Данных Основного Приложения

Этот документ описывает требования к основной базе данных системы AI Cabinet, которая хранит все мастер-данные.

---

### 1. Основная цель

Создать и поддерживать основную, авторитетную базу данных для системы AI Cabinet. Эта база данных является **единственным источником истины** для основных бизнес-сущностей: `sites` и `users`. Она является отдельным компонентом от базы данных сервиса RAG и внутренней базы данных n8n.

---

### 2. Архитектура и Стек Технологий

-   **База данных:** **PostgreSQL** (рекомендуется версия 14+).
-   **Управление схемой:** **Alembic**. Все изменения схемы должны управляться с помощью миграций Alembic, основанных на моделях, определенных в файле `models.py` основного проекта.
-   **Сеть:** **Tailscale**. Сервер базы данных должен быть частью сети Tailscale проекта. Все соединения с этой базой данных от других сервисов (таких как n8n или будущие панели администратора) **должны** осуществляться исключительно через частную сеть Tailscale. Порт базы данных (например, 5432) **не должен** быть открыт для публичного интернета.

---

### 3. Обязанности (Что Хранит Эта База Данных)

Эта база данных исключительно отвечает за хранение и управление следующими основными сущностями:

-   **Таблица `sites`:** Содержит все данные конфигурации для каждого клиентского сайта, включая домены, промпты ИИ, брендинг и детали интеграции с HubSpot. Это основная запись для настроек сайта.
-   **Таблица `users`:** Содержит основной список всех зарегистрированных пользователей. `user_id` в этой таблице является основным идентификатором, который связывает пользователя со всеми сервисами.

---

### 4. Необязанности (Что Эта База Данных НЕ Хранит)

Для обеспечения четкого разделения обязанностей эта база данных **не должна** использоваться для:

-   **Истории чата:** Все логи разговоров (`chat_messages`) являются ответственностью **Базы данных Сервиса RAG**.
-   **Векторных вложений:** Все векторизованные данные для извлечения знаний (`knowledge_documents`) являются ответственностью **Базы данных Сервиса RAG**.
-   **Внутренних данных n8n:** Эта база данных не должна использоваться для внутренних операций n8n (рабочих процессов, учетных данных, логов выполнения).

---

### 5. Взаимодействие с Другими Сервисами

-   **Рабочий процесс n8n:** Рабочий процесс n8n будет настроен с учетными данными для прямого подключения к этой базе данных PostgreSQL через ее **IP-адрес Tailscale или имя MagicDNS**. Он будет выполнять `SELECT` запросы к таблице `sites` для получения конфигурации (например, `ai_prompt`) в начале выполнения рабочего процесса.
-   **Панель администратора (Будущее):** Любой будущий административный интерфейс для управления пользователями или сайтами будет выполнять операции `CREATE`, `UPDATE` и `DELETE` непосредственно над таблицами в этой базе данных, также через сеть Tailscale.

---

### 6. Схема Базы Данных

Следующие таблицы должны быть созданы и управляться в этой базе данных с помощью миграций Alembic.

#### Таблица: `sites`
Основная запись для всех конфигураций сайта.

| Колонка            | Тип         | Описание                                  |
| ------------------ | ----------- | ----------------------------------------- |
| `site_id`          | `string`    | **Первичный ключ.** Уникальный идентификатор для сайта. |
| `domain`           | `string`    | Доменное имя, связанное с сайтом.         |
| `ai_script_id`     | `string`    | Идентификатор для конкретного скрипта или версии ИИ. |
| `ai_prompt`        | `text`      | Системный промпт для модели ИИ.           |
| `brand_name`       | `string`    | Название бренда для сайта.                |
| `language`         | `string`    | Язык для ИИ (например, 'en', 'de').       |
| `hubspot_pipeline` | `string`    | Целевой ID конвейера HubSpot.             |
| `hubspot_stage`    | `string`    | Целевой ID стадии HubSpot.                |
| `created_at`       | `timestamp` | Отметка времени создания.                 |

#### Таблица: `users`
Основная запись для всех пользователей в системе.

| Колонка      | Тип         | Описание                                  |
| ------------ | ----------- | ----------------------------------------- |
| `user_id`    | `string`    | **Первичный ключ.** ID пользователя из Zitadel (`sub`). |
| `email`      | `string`    | Адрес электронной почты пользователя.      |
| `first_seen` | `timestamp` | Когда пользователь был впервые замечен.    |
| `last_seen`  | `timestamp` | Когда пользователь был последний раз активен. |
