# Техническое задание (ТЗ) для AI Кабинета - Бэкенд (n8n)

Этот документ описывает задачи бэкенда, которые должны быть реализованы на платформе n8n, служащей API для системы AI Кабинета.

---

### 1. Основная цель

Создать безопасный рабочий процесс n8n, который будет действовать как бэкенд API. Этот API будет получать сообщения от пользователя, обрабатывать их с использованием модели ИИ, взаимодействовать с базой данных PostgreSQL (Supabase) и CRM HubSpot, а затем возвращать ответ пользователю.

---

### 2. Конечная точка API (Webhook n8n)

-   **Триггер:** Рабочий процесс должен запускаться узлом n8n **Webhook**.
-   **Метод:** Вебхук должен быть настроен на прием `POST` запросов.
-   **Ввод с фронтенда:** Вебхук будет получать JSON-тело следующей структуры:
    ```json
    {
      "message": "Текст сообщения пользователя",
      "site_id": "Идентификатор сайта, например, 'default_site'"
    }
    ```
-   **Развертывание:** URL вебхука будет безопасно доступен через Интернет через **Cloudflare Tunnel**.

---

### 3. Аутентификация (Валидация JWT Zitadel)

Это критически важное требование безопасности. API не должен обрабатывать запросы, которые не прошли надлежащую аутентификацию.

-   **Требование:** Каждый входящий запрос к вебхуку должен содержать заголовок `Authorization: Bearer <accessToken>`.
-   **Реализация:**
    1.  Сразу после узла Webhook добавьте шаг для извлечения `accessToken` из заголовка.
    2.  **Валидация токена:** Рабочий процесс должен валидировать JWT `accessToken`. Это включает:
        -   Получение публичных ключей (JWKS) из конечной точки Zitadel `jwks_uri` (`https://<ваш-домен-zitadel>/oauth/v2/keys`).
        -   Проверку подписи токена с использованием этих ключей.
        -   Проверку срока действия токена (`exp`) и издателя (`iss`).
    3.  **В случае успеха:** Если токен действителен, извлеките утверждение `sub`. Это уникальный `user_id`.
    4.  **В случае неудачи:** Если токен отсутствует или недействителен, рабочий процесс должен немедленно остановиться и вернуть ошибку `HTTP 401 Unauthorized`.

---

### 4. Логика базы данных (PostgreSQL / Supabase)

Рабочий процесс должен читать и записывать данные в базу данных PostgreSQL.

-   **Подключение:** Настройте подключение к базе данных Supabase, используя предоставленные учетные данные.
-   **Задачи:**
    1.  **Получение конфигурации сайта:** Используя `site_id` из входных данных вебхука, запросите таблицу `sites` для получения конфигурации текущего сайта, особенно `ai_prompt`.
    2.  **Получение истории чата:** Перед вызовом ИИ получите последние 5-10 сообщений для текущего `user_id` и `site_id` из таблицы `chat_messages`, чтобы предоставить контекст ИИ.
    3.  **Сохранение сообщения пользователя:** Вставьте входящее сообщение пользователя в таблицу `chat_messages` (`role: 'user'`).
    4.  **Сохранение ответа ИИ:** После того как ИИ сгенерирует ответ, вставьте его в таблицу `chat_messages` (`role: 'ai'`).

---

### 5. Логика ИИ (OpenAI / Anthropic)

-   **Подключение:** Настройте соответствующий узел (например, узел OpenAI) с необходимыми ключами API.
-   **Реализация:**
    1.  **Формирование промпта:** Создайте промпт для модели ИИ. Этот промпт должен включать:
        -   Системный промпт (`ai_prompt`), полученный из таблицы `sites`.
        -   Недавнюю историю чата, полученную из базы данных.
        -   Последнее сообщение пользователя.
    2.  **Вызов API ИИ:** Отправьте сформированный промпт модели ИИ.
    3.  **Обработка ответа:** Получите текстовый ответ от ИИ.

---

### 6. Логика CRM HubSpot

-   **Подключение:** Настройте узел HubSpot с необходимыми учетными данными API.
-   **Задачи:**
    1.  **Проверка/Создание контакта:**
        -   Используйте `user_id` (из токена), чтобы проверить, существует ли контакт с соответствующим `ucloud_user_id` в HubSpot.
        -   Если нет, создайте новый контакт.
        -   Если существует, обновите его.
    2.  **Обновление свойств контакта:** Заполните пользовательские свойства записи контакта HubSpot, как определено в основном `Task.md`:
        -   `ucloud_user_id`
        -   `ucloud_site_id`
        -   `ucloud_status` (например, установить 'engaged' при первом сообщении)
        -   `ucloud_first_message` / `ucloud_last_message`

---

### 7. Окончательный вывод

-   **В случае успеха:** Рабочий процесс должен завершиться отправкой ответа `200 OK` обратно на фронтенд. Тело ответа должно быть JSON-объектом, содержащим ответ ИИ:
    ```json
    {
      "reply": "Полный текст ответа ИИ."
    }
    ```
-   **В случае ошибки:** Рабочий процесс должен корректно обрабатывать ошибки и возвращать соответствующие коды состояния HTTP (например, 401, 500).

---

### 8. Синхронизация данных (Google Таблицы через n8n)

Для удобства управления конфигурацией и инструкциями AI агентов, n8n будет использоваться для синхронизации данных из Google Таблиц в соответствующие таблицы PostgreSQL. Ниже представлена ожидаемая структура этих таблиц.

#### 8.1. Google Таблица: `Sites Configuration`
Эта таблица будет использоваться для синхронизации данных с таблицей `sites` в основной базе данных.

| Колонка            | Тип (пример) | Описание                                  |
| ------------------ | ------------ | ----------------------------------------- |
| `site_id`          | `string`     | **Уникальный идентификатор сайта.** Должен совпадать с `site_id` в БД. |
| `domain`           | `string`     | Доменное имя, связанное с сайтом.         |
| `ai_script_id`     | `string`     | Идентификатор для конкретного скрипта или версии ИИ. |
| `ai_prompt`        | `text`       | Системный промпт для модели ИИ.           |
| `brand_name`       | `string`     | Название бренда для сайта.                |
| `language`         | `string`     | Язык для ИИ (например, 'en', 'de').       |
| `hubspot_pipeline` | `string`     | Целевой ID конвейера HubSpot.             |
| `hubspot_stage`    | `string`     | Целевой ID стадии HubSpot.                |
| `created_at`       | `timestamp`  | Отметка времени создания (может генерироваться n8n). |

#### 8.2. Google Таблица: `AI Agent Instructions`
Эта таблица будет использоваться для синхронизации данных с таблицей `ai_agent_instructions` в базе данных RAG сервиса.

| Колонка           | Тип (пример) | Описание                                  |
| ----------------- | ------------ | ----------------------------------------- |
| `id`              | `uuid`       | **Уникальный идентификатор инструкции.** Может генерироваться n8n. |
| `site_id`         | `string`     | **Идентификатор сайта.** Связывает инструкцию с конкретным сайтом. |
| `resource_name`   | `string`     | **Уникальное имя ресурса/агента** (например, "Sales Agent", "Support Chatbot"). |
| `instruction_text`| `text`       | Полный текст системной инструкции для AI. |
| `version`         | `string`     | Версия инструкции (необязательно).        |
| `created_at`      | `timestamp`  | Отметка времени создания (может генерироваться n8n). |
| `updated_at`      | `timestamp`  | Отметка времени последнего обновления (может генерироваться n8n). |

---

### Приложение: Схема базы данных

Ожидается, что в базе данных PostgreSQL будут существовать следующие таблицы.

#### Таблица: `sites`
Хранит конфигурацию для каждого сайта.

| Колонка            | Тип         | Описание                                  |
| ------------------ | ----------- | ----------------------------------------- |
| `site_id`          | `string`    | **Первичный ключ.** Уникальный идентификатор сайта. |
| `domain`           | `string`    | Доменное имя, связанное с сайтом.         |
| `ai_script_id`     | `string`    | Идентификатор для конкретного скрипта или версии ИИ. |
| `ai_prompt`        | `text`      | Системный промпт для модели ИИ.           |
| `brand_name`       | `string`    | Название бренда для сайта.                |
| `language`         | `string`    | Язык для ИИ (например, 'en', 'de').       |
| `hubspot_pipeline` | `string`    | Целевой ID конвейера HubSpot.             |
| `hubspot_stage`    | `string`    | Целевой ID стадии HubSpot.                |
| `created_at`       | `timestamp` | Отметка времени создания.                 |

#### Таблица: `chat_messages`
Хранит историю всех разговоров.

| Колонка     | Тип         | Описание                                  |
| ----------- | ----------- | ----------------------------------------- |
| `id`        | `uuid`      | **Первичный ключ.** Уникальный ID сообщения. |
| `user_id`   | `string`    | ID пользователя из JWT Zitadel (`sub` claim). |
| `site_id`   | `string`    | **Внешний ключ** к `sites.site_id`.       |
| `role`      | `string`    | Кто отправил сообщение: 'user' или 'ai'.  |
| `message`   | `text`      | Содержимое сообщения.                     |
| `timestamp` | `timestamp` | Отметка времени сообщения.                |

#### Таблица: `users`
Необязательная таблица для хранения метаданных пользователя.

| Колонка      | Тип         | Описание                                  |
| ------------ | ----------- | ----------------------------------------- |
| `user_id`    | `string`    | **Первичный ключ.** ID пользователя из Zitadel (`sub`). |
| `email`      | `string`    | Адрес электронной почты пользователя.      |
| `first_seen` | `timestamp` | Когда пользователь был впервые замечен.    |
| `last_seen`  | `timestamp` | Когда пользователь был последний раз активен. |
