# Техническое задание (ТЗ) для Сервиса RAG (Retrieval-Augmented Generation)

Этот документ описывает требования к автономному микросервису RAG. Этот сервис будет выступать в качестве "памяти и базы знаний" для системы AI Cabinet.

---

### 1. Основная цель

Разработать микросервис на Python, который предоставляет контекстную информацию основному рабочему процессу ИИ (n8n). Сервис будет управлять двумя типами памяти:

1.  **Долгосрочные знания:** Векторная база данных инструкций, документов и другой контекстной информации.
2.  **Краткосрочная память:** Скользящая 30-дневная история пользовательских разговоров.

Этот сервис заменит необходимость прямого доступа рабочего процесса n8n к базе данных PostgreSQL для задач, связанных с чатом.

---

### 2. Архитектура и Стек Технологий

-   **Язык:** Python 3.10+
-   **Фреймворк:** **FastAPI** (рекомендуется за скорость и автоматическую документацию API).
-   **База данных:** **PostgreSQL** с расширением **`pgvector`** для векторного поиска сходства.
-   **Сеть:** **Tailscale**. Сервис должен быть развернут в частной сети Tailscale. Он **не должен** быть доступен из публичного интернета. Связь между n8n и этим сервисом будет осуществляться исключительно через сеть Tailscale.
-   **Ключевые библиотеки:**
    -   `sqlalchemy` (для ORM)
    -   `alembic` (для миграций базы данных)
    -   `sentence-transformers` или `openai` (для генерации текстовых эмбеддингов)
    -   `uvicorn` (для запуска приложения FastAPI)

---

### 3. Ключевые Особенности

#### 3.1. Управление Документами и Инструкциями (Долгосрочные знания)

-   Сервис должен предоставлять API для добавления, обновления и удаления документов знаний.
-   При добавлении документа сервис должен:
    1.  Разделить текст документа на более мелкие, управляемые фрагменты.
    2.  Сгенерировать векторное вложение для каждого фрагмента с использованием модели sentence-transformer.
    3.  Сохранить текст фрагмента и соответствующий ему вектор в базе данных.

#### 3.2. Управление Историей Чата (Краткосрочная память)

-   Сервис должен предоставлять API для сохранения новых сообщений чата.
-   **Политика хранения данных:** Сервис должен автоматически удалять все сообщения чата старше **30 дней**. Это должно быть реализовано как запланированная фоновая задача (например, ежедневное задание cron).

#### 3.3. Извлечение Контекста

-   Это основная функция сервиса. Он должен предоставлять единую конечную точку API, которая:
    1.  Принимает запрос пользователя, `user_id`, и `site_id`.
    2.  Генерирует вложение для запроса пользователя.
    3.  Выполняет векторный поиск сходства в базе данных для нахождения наиболее релевантных фрагментов знаний для этого запроса и `site_id`.
    4.  Извлекает последние 5-10 сообщений из истории разговора для этого `user_id` и `site_id`.
    5.  Объединяет извлеченные знания и историю чата в единую, отформатированную строку контекста.
    6.  Возвращает эту строку контекста вызывающей стороне (рабочему процессу n8n).

---

### 4. Конечные Точки API

**Примечание:** Все конечные точки должны быть доступны только через их IP-адрес Tailscale или имя MagicDNS.

**`POST /documents`**
-   **Действие:** Добавляет новый документ знаний.
-   **Тело:**
    ```json
    {
      "site_id": "string",
      "source": "string (например, имя файла или URL)",
      "content": "string (полный текст документа)"
    }
    ```
-   **Ответ:** `201 Created` с ID загруженного документа.

**`POST /chat-messages`**
-   **Действие:** Сохраняет новое сообщение в историю разговора.
-   **Body:**
    ```json
    {
      "user_id": "string",
      "site_id": "string",
      "role": "string ('user' или 'ai')",
      "message": "string"
    }
    ```
-   **Ответ:** `201 Created`.

**`POST /retrieve-context`**
-   **Действие:** Основная конечная точка RAG. Извлекает контекст для данного запроса.
-   **Body:**
    ```json
    {
      "user_id": "string",
      "site_id": "string",
      "query": "string (текущее сообщение пользователя)"
    }
    ```
-   **Ответ:** `200 OK` с JSON-телом:
    ```json
    {
      "context": "Единая строка, содержащая отформатированные фрагменты знаний и недавнюю историю чата."
    }
    ```

**`DELETE /chat-messages/cleanup`** (Защищенная конечная точка)
-   **Действие:** Вручную запускает очистку сообщений чата старше 30 дней. Должна вызываться планировщиком.
-   **Ответ:** `200 OK` со сводкой очистки.

---

### 5. Схема Базы Данных

Сервис будет использовать следующие таблицы. Для управления миграциями должен использоваться Alembic.

#### Таблица: `knowledge_documents`
Хранит векторизованные фрагменты долгосрочных знаний.

| Колонка     | Тип                       | Описание                                  |
| ----------- | ------------------------- | ----------------------------------------- |
| `id`        | `uuid`                    | **Первичный ключ.**                       |
| `site_id`   | `string`                  | Ограничивает знания конкретным сайтом.    |
| `source`    | `string`                  | Исходный источник документа.              |
| `content`   | `text`                    | Необработанный текст фрагмента документа. |
| `embedding` | `vector(dimension)`       | **Тип pgvector.** Вложение содержимого.   |
| `created_at`| `timestamp`               | Отметка времени создания.                 |

#### Таблица: `chat_messages`
(Это может быть та же таблица, что используется основным приложением).

| Колонка     | Тип         | Описание                                  |
| ----------- | ----------- | ----------------------------------------- |
| `id`        | `uuid`      | **Первичный ключ.**                       |
| `user_id`   | `string`    | ID пользователя из JWT Zitadel (`sub` claim). |
| `site_id`   | `string`    | **Внешний ключ** к `sites.site_id`.       |
| `role`      | `string`    | 'user' или 'ai'.                          |
| `message`   | `text`      | Содержимое сообщения.                     |
| `timestamp` | `timestamp` | **Критически важно для политики хранения 30 дней.** |

#### Таблица: `ai_agent_instructions`
Хранит системные инструкции для AI агентов, специфичные для сайта или ресурса.

| Колонка           | Тип         | Описание                                  |
| ----------------- | ----------- | ----------------------------------------- |
| `id`              | `uuid`      | **Первичный ключ.**                       |
| `site_id`         | `string`    | **Внешний ключ** к `sites.site_id`. Связывает инструкцию с конкретным сайтом. |
| `resource_name`   | `string`    | Уникальное имя ресурса/агента (например, "Sales Agent", "Support Chatbot"). |
| `instruction_text`| `text`      | Полный текст системной инструкции для AI. |
| `version`         | `string`    | Версия инструкции (необязательно).        |
| `created_at`      | `timestamp` | Отметка времени создания.                 |
| `updated_at`      | `timestamp` | Отметка времени последнего обновления.    |
