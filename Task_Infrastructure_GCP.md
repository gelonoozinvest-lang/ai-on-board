# Техническое задание (ТЗ) для Репозитория Инфраструктуры GCP

Этот документ описывает требования к выделенному Git-репозиторию, который будет управлять всей инфраструктурой Google Cloud Platform (GCP) для проекта AI Cabinet с использованием Terraform.

---

### 1. Основная цель

Определить, создать и управлять всеми необходимыми ресурсами GCP для системы AI Cabinet, используя парадигму "Инфраструктура как код" (IaC) с Terraform. Этот репозиторий будет единственным источником истины для облачной инфраструктуры проекта.

---

### 2. Структура Репозитория (Рекомендуется)

Требуется модульная структура для ясности и повторного использования.

```
/
├── main.tf         # Основной файл, оркеструет создание модулей
├── variables.tf    # Определяет входные переменные (project_id, region и т.д.)
├── outputs.tf      # Определяет выходные данные (например, имена экземпляров баз данных)
├── terraform.tfvars.example # Пример файла переменных
├── .gitignore      # Игнорирует .tfstate, .tfvars и т.д.
└── modules/
    ├── cloud-sql/
    │   └── main.tf   # Модуль для создания экземпляра Cloud SQL PostgreSQL
    └── tailscale-gateway/
        └── main.tf   # Модуль для создания VM шлюза Tailscale
```

---

### 3. Создаваемые Ресурсы

#### 3.1. База данных основного приложения
-   **Ресурс:** `Cloud SQL для PostgreSQL`.
-   **Назначение:** Основная база данных для таблиц `users` и `sites`.
-   **Размер экземпляра (Production):** `db-n2-standard-2` или аналогичный.
-   **Настройки:**
    -   Высокая доступность (Региональная) должна быть **включена**.
    -   Автоматическое резервное копирование должно быть **включено**.
    -   **Частный IP** должен быть включен. Публичный IP должен быть **отключен**.
    -   Расширение `pgvector` **не требуется** для этого экземпляра.

#### 3.2. База данных сервиса RAG
-   **Ресурс:** `Cloud SQL для PostgreSQL`.
-   **Назначение:** Выделенная база данных для сервиса RAG, хранящая `chat_messages` и `knowledge_documents`.
-   **Размер экземпляра (Production):** `db-n2-standard-4` или больше, оптимизированный для ЦП и ОЗУ.
-   **Настройки:**
    -   Высокая доступность (Региональная) должна быть **включена**.
    -   Расширение **`pgvector` должно быть включено** через флаги базы данных.
    -   **Частный IP** должен быть включен. Публичный IP должен быть **отключен**.

#### 3.3. VM шлюза Tailscale
-   **Ресурс:** `Compute Engine VM`.
-   **Назначение:** Действовать как безопасный шлюз, предоставляя доступ к экземплярам Cloud SQL из частной сети Tailscale.
-   **Размер экземпляра:** `e2-micro` (или другой экономически эффективный эквивалент).
-   **Настройки:**
    -   VM должна быть развернута в том же VPC, что и экземпляры Cloud SQL.
    -   У нее **не должно** быть публичного IP-адреса.
    -   Должен использоваться **скрипт запуска** для:
        1.  Установки Tailscale.
        2.  Аутентификации и подключения к сети Tailscale с использованием ключа аутентификации.
        3.  Установки Google Cloud SQL Auth Proxy.

---

### 4. Сеть и Безопасность

-   **VPC:** Все ресурсы должны быть развернуты в одной сети VPC.
-   **Доступ:** Весь доступ к базам данных из прикладных сервисов (n8n, сервис RAG) должен маршрутизироваться через **VM шлюза Tailscale** и **Cloud SQL Auth Proxy**. Прямые подключения к частному IP базы данных должны быть настроены внутри прокси.
-   **Правила брандмауэра:** Правила брандмауэра должны быть настроены для разрешения необходимого внутреннего трафика, ограничивая при этом весь внешний доступ.

---

### 5. Управление Конфигурацией и Секретами

-   **Идентификатор проекта и регион:** Они должны быть определены как переменные в `variables.tf` и предоставлены через файл `terraform.tfvars`.
-   **`terraform.tfvars`:** Этот файл будет содержать все конфиденциальные данные (идентификатор проекта GCP, ключ аутентификации Tailscale) и **должен быть включен в `.gitignore`**.
-   **Сервисный аккаунт:** Terraform потребуется сервисный аккаунт GCP с соответствующими разрешениями (`Cloud SQL Admin`, `Compute Admin` и т.д.) для управления ресурсами. Учетные данные для этого сервисного аккаунта должны быть безопасно настроены на машине, где выполняются команды Terraform.

---

### 6. Рабочий процесс Развертывания

1.  Клонируйте репозиторий инфраструктуры.
2.  Создайте файл `terraform.tfvars` из шаблона `terraform.tfvars.example` и заполните необходимые значения.
3.  Аутентифицируйтесь в GCP (например, `gcloud auth application-default login`).
4.  Выполните `terraform init` для инициализации рабочего пространства.
5.  Выполните `terraform plan` для просмотра запланированных изменений.
6.  Выполните `terraform apply` для создания или обновления инфраструктуры.
